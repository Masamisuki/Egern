name: Sync Sukka Reject Rules

on:
  schedule:
    # 每天凌晨 0 点同步一次
    - cron: '0 0 * * *'
  workflow_dispatch: # 支持手动点击运行

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download and Process Rule
        run: |
          # 1. 设置路径和文件名
          SAVE_DIR="Tool/Egern/Rules"
          FILE_NAME="reject_Sukka"
          DEST_PATH="$SAVE_DIR/$FILE_NAME"
          
          mkdir -p "$SAVE_DIR"

          # 2. 下载 domainset 版本的 reject.conf
          echo "Downloading rule from skk.moe (domainset)..."
          curl -sSL "https://ruleset.skk.moe/List/domainset/reject.conf" -o "$DEST_PATH"

          # 3. 使用 sed 删除指定的广告/标识域名
          echo "Filtering specified domains..."
          sed -i -e '/DOMAIN,this_ruleset_is_made_by_sukkaw.ruleset.skk.moe/d' "$DEST_PATH"
          sed -i -e '/DOMAIN,th1s_rule5et_1s_m4d3_by_5ukk4w_ruleset.skk.moe/d' "$DEST_PATH"
          sed -i -e '/DOMAIN,this_rule_set_is_made_by_sukkaw.skk.moe/d' "$DEST_PATH"
          sed -i -e '/DOMAIN,7h1s_rul35et_i5_mad3_by_5ukk4w-ruleset.skk.moe/d' "$DEST_PATH"

          echo "Process finished."

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 只有在文件内容有变化时才提交
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "chore: sync reject_Sukka rules from upstream"
            git push
          else
            echo "No changes to commit."
          fi
