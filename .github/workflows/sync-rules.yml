name: Sync Rules

on:
  schedule:
    # 每天凌晨 0 点同步一次 (UTC时间)
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许手动触发执行

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download and Process Rule
        run: |
          # 设定保存路径（如果文件夹不存在则创建）
          SAVE_DIR="Tool/Egern/Rules"
          FILE_NAME="reject.conf"
          DEST_PATH="$SAVE_DIR/$FILE_NAME"
          
          mkdir -p "$SAVE_DIR"

          # 下载文件
          echo "Downloading rule from skk.moe..."
          curl -sSL "https://ruleset.skk.moe/List/non_ip/reject.conf" -o "$DEST_PATH"

          # 使用 sed 删除指定的域名行
          echo "Filtering domains..."
          sed -i -e '/DOMAIN,this_ruleset_is_made_by_sukkaw.ruleset.skk.moe/d' "$DEST_PATH"
          sed -i -e '/DOMAIN,th1s_rule5et_1s_m4d3_by_5ukk4w_ruleset.skk.moe/d' "$DEST_PATH"
          sed -i -e '/DOMAIN,this_rule_set_is_made_by_sukkaw.skk.moe/d' "$DEST_PATH"
          sed -i -e '/DOMAIN,7h1s_rul35et_i5_mad3_by_5ukk4w-ruleset.skk.moe/d' "$DEST_PATH"

          echo "Rule processing completed."

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 检查是否有文件更改
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "chore: sync reject rules from upstream $(date +'%Y-%m-%d')"
            git push
          else
            echo "No changes detected, skipping commit."
          fi
