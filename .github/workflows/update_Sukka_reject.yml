name: Update Sukka Reject for Egern

on:
  workflow_dispatch:
  schedule:
    - cron: "5 0,12 * * *"

jobs:
  Build:
    runs-on: ubuntu-latest
    env:
      TZ: "Asia/Shanghai"

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6.0.0
      with:
        repository: Repcz/Tool
        path: Tool-repo

    - name: Process Ads_SukkaW for Egern
      run: |
        #!/bin/bash
        # 1. 下载与合并 SukkaW 规则
        mkdir -p Tool-repo/Ruleset
        urls=(
            "https://ruleset.skk.moe/List/domainset/reject.conf"
            "https://ruleset.skk.moe/List/non_ip/reject.conf"
        )
        > Tool-repo/Ruleset/Ads_SukkaW.list
        for url in "${urls[@]}"; do
            echo "Downloading: $url"
            curl -f -L "$url" >> Tool-repo/Ruleset/Ads_SukkaW.list || { echo "Download Failed: $url"; exit 1; }
            echo "" >> Tool-repo/Ruleset/Ads_SukkaW.list
        done

        # 2. 格式标准化 (Source build 逻辑)
        file="Tool-repo/Ruleset/Ads_SukkaW.list"
        sed -i '/^\./s/^\./DOMAIN-SUFFIX,/' "$file"
        sed -i -E '/^\s*$/b; /^\s*[#;]/b; /^DOMAIN,|^DOMAIN-SUFFIX,|^DOMAIN-KEYWORD,|^DOMAIN-WILDCARD,|^IP-CIDR,|^IP-CIDR6,|^IP-ASN,|^GEOIP,|^AND,|^OR,|^NOT,|^URL-REGEX,|^USER-AGENT,|^PROCESS-NAME,|^DEST-PORT,/b; s/^([^#])/DOMAIN,\1/' "$file"
        sed -i -e '/^\s*[#;]/d' -e '/^$/d' -e 's| //.*||'  "$file"
        sed -i -e '/DOMAIN,this_ruleset_is_made_by_sukkaw.ruleset.skk.moe/d' \
               -e '/DOMAIN,th1s_rule5et_1s_m4d3_by_5ukk4w_ruleset.skk.moe/d' \
               -e '/DOMAIN,this_rule_set_is_made_by_sukkaw.skk.moe/d' \
               -e '/DOMAIN,7h1s_rul35et_i5_mad3_by_5ukk4w-ruleset.skk.moe/d' "$file"
        sed -i -e 's/,reject$//' -e 's/, */,/g' "$file"

        # 3. 排序与去重 (Source sort 逻辑)
        sed -i -E '/^IP-CIDR,/!{/^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\/[0-9]+/s/^/IP-CIDR,/}' "$file"
        awk '
        /^DOMAIN,/         { print "0 " $0; next }
        /^DOMAIN-SUFFIX,/  { print "1 " $0; next }
        /^DOMAIN-KEYWORD,/ { print "2 " $0; next }
        /^IP-CIDR,/        { print "4 " $0; next }
                           { print "15 " $0; next }
        ' "$file" | sort -k1,1n -k2,2 | cut -d' ' -f2- > "$file.sorted" && mv "$file.sorted" "$file"
        awk '!seen[tolower($0)]++' "$file" > temp && mv temp "$file"

        # 4. 转换为 Egern 格式并保存到指定路径
        mkdir -p Tool-repo/Egern/Rules
        egern_file="Tool-repo/Egern/Rules/Ads_SukkaW.yaml"
        cp "$file" "$egern_file"

        # 清洗 Egern 不支持的规则并添加 YAML 键名
        sed -i -e '/^USER-AGENT/d' -e '/^PROCESS-NAME/d' -e '/^AND/d' -e '/^OR/d' -e '/^NOT/d' "$egern_file"
        awk '/^DOMAIN,/ && !d_added {print "domain_set:"; d_added=1} {print}' "$egern_file" > tmp && mv tmp "$egern_file"
        awk '/^DOMAIN-SUFFIX,/ && !ds_added {print "domain_suffix_set:"; ds_added=1} {print}' "$egern_file" > tmp && mv tmp "$egern_file"
        awk '/^DOMAIN-KEYWORD,/ && !dk_added {print "domain_keyword_set:"; dk_added=1} {print}' "$egern_file" > tmp && mv tmp "$egern_file"
        awk '/^IP-CIDR,/ && !ip_added {print "ip_cidr_set:"; ip_added=1} {print}' "$egern_file" > tmp && mv tmp "$egern_file"

        # 转换为 YAML 列表格式并统计
        sed -i -E 's/^(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD|IP-CIDR),/  - /g' "$egern_file"
        file_names=$(basename "$egern_file" .yaml)
        line_count=$(grep -c '^  - ' "$egern_file")
        awk -v fname="$file_names" 'NR==1 {print "# 规则名称: " fname} {print}' "$egern_file" > tmp && mv tmp "$egern_file"
        awk -v count="$line_count" 'NR==2 {print "# 规则统计: " count} {print}' "$egern_file" > tmp && mv tmp "$egern_file"
        sed -i '2a\\' "$egern_file"

    - name: Push Update
      run: |
        cd Tool-repo
        if [[ -n $(git status -s) ]]; then
          git config --local user.email "${{ github.actor }}@users.noreply.github.com"
          git config --local user.name "${{ github.actor }}"
          git add Egern/Rules/Ads_SukkaW.yaml
          git commit -m "Update(Egern-Rules): $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          git push origin X
        else
          echo "No changes to commit."
        fi
