name: Update Sukka Reject for Egern

on:
  workflow_dispatch:
  schedule:
    - cron: "5 0,12 * * *"

# 必须声明权限，否则无法推送代码到你自己的仓库
permissions:
  contents: write

jobs:
  Build:
    runs-on: ubuntu-latest
    env:
      TZ: "Asia/Shanghai"

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        # 修正：删除了 repository: Repcz/Tool，改为检出你当前的仓库
        path: Tool-repo

    - name: Process Ads_SukkaW for Egern
      run: |
        #!/bin/bash
        # 1. 下载与合并
        mkdir -p Tool-repo/Ruleset
        urls=(
            "https://ruleset.skk.moe/List/domainset/reject.conf"
            "https://ruleset.skk.moe/List/non_ip/reject.conf"
        )
        > Tool-repo/Ruleset/Ads_SukkaW.list
        for url in "${urls[@]}"; do
            echo "Downloading: $url"
            curl -f -L "$url" >> Tool-repo/Ruleset/Ads_SukkaW.list || { echo "Download Failed: $url"; exit 1; }
            echo "" >> Tool-repo/Ruleset/Ads_SukkaW.list
        done

        # 2. 格式标准化与清洗 (沿用原始 Build.yml 逻辑)
        file="Tool-repo/Ruleset/Ads_SukkaW.list"
        sed -i '/^\./s/^\./DOMAIN-SUFFIX,/' "$file"
        sed -i -E '/^\s*$/b; /^\s*[#;]/b; /^DOMAIN,|^DOMAIN-SUFFIX,|^DOMAIN-KEYWORD,|^DOMAIN-WILDCARD,|^IP-CIDR,|^IP-CIDR6,|^IP-ASN,|^GEOIP,|^AND,|^OR,|^NOT,|^URL-REGEX,|^USER-AGENT,|^PROCESS-NAME,|^DEST-PORT,/b; s/^([^#])/DOMAIN,\1/' "$file"
        sed -i -e '/^\s*[#;]/d' -e '/^$/d' -e 's| //.*||'  "$file"
        sed -i -e '/DOMAIN,this_ruleset_is_made_by_sukkaw/d' -e 's/,reject$//' -e 's/, */,/g' "$file"

        # 3. 排序与去重
        sed -i -E '/^IP-CIDR,/!{/^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\/[0-9]+/s/^/IP-CIDR,/}' "$file"
        awk '/^DOMAIN,/ {print "0 "$0;next} /^DOMAIN-SUFFIX,/ {print "1 "$0;next} /^DOMAIN-KEYWORD,/ {print "2 "$0;next} /^IP-CIDR,/ {print "4 "$0;next} {print "15 "$0}' "$file" | sort -k1,1n -k2,2 | cut -d' ' -f2- > "$file.sorted"
        awk '!seen[tolower($0)]++' "$file.sorted" > "$file"

        # 4. 转换为 Egern 专用格式 (保存到 Tool-repo/Egern/Rules/)
        mkdir -p Tool-repo/Egern/Rules
        egern_file="Tool-repo/Egern/Rules/Ads_SukkaW.yaml"
        cp "$file" "$egern_file"
        
        sed -i -e '/^USER-AGENT/d' -e '/^PROCESS-NAME/d' -e '/^AND/d' -e '/^OR/d' -e '/^NOT/d' "$egern_file"
        awk '/^DOMAIN,/ && !d_added {print "domain_set:"; d_added=1} {print}' "$egern_file" > tmp && mv tmp "$egern_file"
        awk '/^DOMAIN-SUFFIX,/ && !ds_added {print "domain_suffix_set:"; ds_added=1} {print}' "$egern_file" > tmp && mv tmp "$egern_file"
        awk '/^DOMAIN-KEYWORD,/ && !dk_added {print "domain_keyword_set:"; dk_added=1} {print}' "$egern_file" > tmp && mv tmp "$egern_file"
        awk '/^IP-CIDR,/ && !ip_added {print "ip_cidr_set:"; ip_added=1} {print}' "$egern_file" > tmp && mv tmp "$egern_file"

        sed -i -E 's/^(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD|IP-CIDR),/  - /g' "$egern_file"
        line_count=$(grep -c '^  - ' "$egern_file")
        awk -v fname="Ads_SukkaW" 'NR==1 {print "# 规则名称: " fname} {print}' "$egern_file" > tmp && mv tmp "$egern_file"
        awk -v count="$line_count" 'NR==2 {print "# 规则统计: " count} {print}' "$egern_file" > tmp && mv tmp "$egern_file"
        sed -i '2a\\' "$egern_file"

    - name: Push Update
      run: |
        cd Tool-repo
        git config --local user.email "${{ github.actor }}@users.noreply.github.com"
        git config --local user.name "${{ github.actor }}"
        git add Egern/Rules/Ads_SukkaW.yaml
        git commit -m "Update(Egern-Rules): $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" || exit 0
        # 修正：直接推送到你当前检出的分支
        git push
