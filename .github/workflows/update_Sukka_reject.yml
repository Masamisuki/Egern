- name: Build Sukka_reject for Egern
      run: |
        # 1. 创建目标目录
        mkdir -p Tool-repo/Egern/Rules
        
        # 2. 下载并合并 SukkaW 上游 Reject 规则
        urls=(
            "https://ruleset.skk.moe/List/domainset/reject.conf"
            "https://ruleset.skk.moe/List/non_ip/reject.conf"
        )
        temp_list="Tool-repo/Egern/Rules/Sukka_reject.list"
        > "$temp_list"
        for url in "${urls[@]}"; do
            echo "Downloading: $url"
            curl -f -L "$url" >> "$temp_list" || { echo "Download Failed"; exit 1; }
            echo "" >> "$temp_list"
        done

        # 3. 标准化处理 (Source build 逻辑)
        # 转换前缀并添加 DOMAIN 标签
        sed -i '/^\./s/^\./DOMAIN-SUFFIX,/' "$temp_list"
        sed -i -E '/^\s*$/b; /^\s*[#;]/b; /^DOMAIN,|^DOMAIN-SUFFIX,|^DOMAIN-KEYWORD,|^DOMAIN-WILDCARD,|^IP-CIDR,|^IP-CIDR6,|^IP-ASN,|^GEOIP,|^AND,|^OR,|^NOT,|^URL-REGEX,|^USER-AGENT,|^PROCESS-NAME,|^DEST-PORT,/b; s/^([^#])/DOMAIN,\1/' "$temp_list"
        
        # 删除注释、空行及末尾多余内容
        sed -i -e '/^\s*[#;]/d' -e '/^$/d' -e 's| //.*||' -e 's/,reject$//' "$temp_list"
        
        # 【关键】删除 SukkaW 规则集中的水印域名
        sed -i -e '/DOMAIN,this_ruleset_is_made_by_sukkaw.ruleset.skk.moe/d' \
               -e '/DOMAIN,th1s_rule5et_1s_m4d3_by_5ukk4w_ruleset.skk.moe/d' \
               -e '/DOMAIN,this_rule_set_is_made_by_sukkaw.skk.moe/d' \
               -e '/DOMAIN,7h1s_rul35et_i5_mad3_by_5ukk4w-ruleset.skk.moe/d' "$temp_list"

        # 4. 转换为 Egern YAML 格式
        target_yaml="Tool-repo/Egern/Rules/Sukka_reject.yaml"
        cp "$temp_list" "$target_yaml"
        
        # 删除 Egern 不支持的类型
        sed -i -e '/^USER-AGENT/d' -e '/^PROCESS-NAME/d' -e '/^AND/d' -e '/^OR/d' -e '/^NOT/d' "$target_yaml"
        
        # 插入 YAML 节点头部标记 (使用 awk 确保每组只出现一次)
        awk '/^DOMAIN,/ && !a {print "domain_set:"; a=1} {print}' "$target_yaml" > tmp && mv tmp "$target_yaml"
        awk '/^DOMAIN-SUFFIX,/ && !a {print "domain_suffix_set:"; a=1} {print}' "$target_yaml" > tmp && mv tmp "$target_yaml"
        awk '/^URL-REGEX,/ && !a {print "url_regex_set:"; a=1} {print}' "$target_yaml" > tmp && mv tmp "$target_yaml"

        # 【核心修改】转换为 YAML 列表格式，且不给 URL-REGEX 加引号
        sed -i -E 's/^(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD|DOMAIN-WILDCARD|DEST-PORT|IP-CIDR|IP-CIDR6|IP-ASN|URL-REGEX|GEOIP),/  - /g' "$target_yaml"

        # 5. 添加统计头信息并清理临时文件
        line_count=$(grep -c '^  - ' "$target_yaml")
        awk -v count="$line_count" 'NR==1 {print "# 规则名称: Sukka_reject\n# 规则统计: " count "\n"} {print}' "$target_yaml" > tmp && mv tmp "$target_yaml"
        rm "$temp_list"
        
        echo "Successfully created: $target_yaml"
